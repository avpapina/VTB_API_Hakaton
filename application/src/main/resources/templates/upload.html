<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .subtitle {
            color: #64748b;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        .upload-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            background: #f9fafb;
            transition: all 0.3s ease;
        }
        input[type="file"]:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .message {
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .message.success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        .message.error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 30px 0;
        }
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
        .result-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .result-card h3 {
            margin-top: 0;
            color: #1e293b;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 12px;
            font-size: 1.2rem;
        }
        .task-list, .endpoint-list {
            list-style: none;
            padding-left: 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .task-item, .endpoint-item {
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #3b82f6;
        }
        .task-item.gateway {
            border-left-color: #10b981;
        }
        .mappings-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin: 25px 0;
        }
        .mapping-item {
            padding: 18px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }
        .mapping-item.matched {
            border-left: 4px solid #10b981;
        }
        .mapping-item.unmatched {
            border-left: 4px solid #ef4444;
        }
        .confidence-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }
        .nav-links {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .nav-link {
            padding: 10px 20px;
            background: white;
            color: #374151;
            text-decoration: none;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .file-info {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 5px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .test-stats {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        .step-item {
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }
        .step-success {
            border-left-color: #10b981;
        }
        .step-failed {
            border-left-color: #ef4444;
        }
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .icon-success {
            background-color: #10b981;
        }
        .icon-failed {
            background-color: #ef4444;
        }
        .step-details {
            font-size: 0.9rem;
            color: #6b7280;
            margin-left: 34px;
        }
        .text-green-600 { color: #059669; }
        .text-red-600 { color: #dc2626; }
        .text-orange-600 { color: #ea580c; }
        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            margin-top: 5px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ */
        .reports-btn {
            background: #8b5cf6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-left: 10px;
        }
        .reports-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            color: white;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>BPMN AI Test Generator</h1>
        <p class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ BPMN –¥–∏–∞–≥—Ä–∞–º–º—É –∏ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤</p>
    </div>

    <div class="upload-card">
        <form method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="bpmnFile">BPMN —Ñ–∞–π–ª</label>
                <input type="file" id="bpmnFile" name="bpmnFile" accept=".bpmn,.xml" required>
                <div class="file-info">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: .bpmn, .xml</div>
            </div>

            <div class="form-group">
                <label for="openapiFile">OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è</label>
                <input type="file" id="openapiFile" name="openapiFile" accept=".yaml,.yml,.json" required>
                <div class="file-info">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: .yaml, .yml, .json</div>
            </div>

            <div style="display: flex; gap: 15px; align-items: center;">
                <button type="submit" class="btn-primary">üöÄ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                <a href="/reports" class="reports-btn">üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç—ã</a>
            </div>
        </form>
    </div>

    <div th:if="${message}" class="message" th:classappend="${message.contains('‚ùå') or message.contains('–û—à–∏–±–∫–∞')} ? 'error' : 'success'" th:text="${message}"></div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
    <div th:if="${bpmnResult != null or openApiResult != null}">
        <div class="results-grid">
            <!-- BPMN –∞–Ω–∞–ª–∏–∑ -->
            <div class="result-card" th:if="${bpmnResult != null}">
                <h3>üìã BPMN –ê–Ω–∞–ª–∏–∑</h3>
                <p><strong>–ü—Ä–æ—Ü–µ—Å—Å:</strong> <span th:text="${bpmnResult.name}"></span></p>
                <p><strong>ID –ø—Ä–æ—Ü–µ—Å—Å–∞:</strong> <span th:text="${bpmnResult.id}"></span></p>

                <h4 style="margin-top: 20px; color: #4b5563;">–ó–∞–¥–∞—á–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞</h4>
                <ul class="task-list">
                    <li class="task-item" th:each="task : ${bpmnResult.tasks}">
                        <strong th:text="${task.name}"></strong>
                        <div style="font-size: 0.9rem; color: #6b7280;">
                            ID: <span th:text="${task.id}"></span> |
                            –¢–∏–ø: <span th:text="${task.type != null ? task.type : 'serviceTask'}"></span>
                        </div>
                        <div th:if="${task.description}" style="font-size: 0.9rem; margin-top: 5px;">
                            <span th:text="${task.description}"></span>
                        </div>
                    </li>
                </ul>

                <h4 style="margin-top: 20px; color: #4b5563;" th:if="${not bpmnResult.gateways.empty}">–®–ª—é–∑—ã</h4>
                <ul class="task-list">
                    <li class="task-item gateway" th:each="gw : ${bpmnResult.gateways}">
                        <strong th:text="${gw.name}"></strong>
                        <div style="font-size: 0.9rem; color: #6b7280;">
                            ID: <span th:text="${gw.id}"></span> | –¢–∏–ø: exclusiveGateway
                        </div>
                    </li>
                </ul>
            </div>

            <!-- OpenAPI –∞–Ω–∞–ª–∏–∑ -->
            <div class="result-card" th:if="${openApiResult != null}">
                <h3>üîó OpenAPI –ê–Ω–∞–ª–∏–∑</h3>
                <ul class="endpoint-list">
                    <li class="endpoint-item" th:each="ep : ${openApiResult.endpoints}">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="padding: 4px 8px; background: #3b82f6; color: white; border-radius: 4px; font-size: 0.8rem; font-weight: 600;"
                                  th:text="${ep.method}"></span>
                            <span style="margin-left: 10px; font-weight: 600;" th:text="${ep.path}"></span>
                        </div>
                        <div style="font-size: 0.9rem; color: #6b7280;">
                            Operation ID: <span th:text="${ep.operationId}"></span>
                        </div>
                        <div th:if="${ep.summary}" style="font-size: 0.9rem; margin-top: 5px;">
                            <span th:text="${ep.summary}"></span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="mappings-card" th:if="${mappings != null}">
            <h3>üîç –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ BPMN –∏ OpenAPI</h3>
            <ul style="list-style: none; padding-left: 0;">
                <li th:each="map : ${mappings}">
                    <div th:class="${map.apiEndpoint != null ? 'mapping-item matched' : 'mapping-item unmatched'}">
                        <div style="display: flex; justify-content: between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <strong>BPMN –∑–∞–¥–∞—á–∞:</strong> <span th:text="${map.bpmnTask.name}"></span>
                                <div style="font-size: 0.9rem; color: #6b7280; margin-top: 5px;">
                                    ID: <span th:text="${map.bpmnTask.id}"></span>
                                </div>
                            </div>
                            <div style="flex: 1;" th:if="${map.apiEndpoint != null}">
                                <strong>API endpoint:</strong>
                                <div style="display: flex; align-items: center; margin-top: 5px;">
                                    <span style="padding: 2px 6px; background: #10b981; color: white; border-radius: 4px; font-size: 0.8rem;"
                                          th:text="${map.apiEndpoint.method}"></span>
                                    <span style="margin-left: 8px; font-weight: 600;" th:text="${map.apiEndpoint.path}"></span>
                                </div>
                                <div style="font-size: 0.9rem; color: #6b7280; margin-top: 5px;">
                                    Operation ID: <span th:text="${map.apiEndpoint.operationId}"></span>
                                </div>
                            </div>
                            <div style="flex: 1;" th:if="${map.apiEndpoint == null}">
                                <span style="color: #ef4444; font-weight: 600;">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π endpoint</span>
                            </div>
                        </div>
                        <div th:if="${map.apiEndpoint != null}" style="margin-top: 10px;">
                            <span class="confidence-badge">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: <span th:text="${#numbers.formatDecimal(map.matchConfidence * 100, 1, 1)}"></span>%</span>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="mappings-card" th:if="${testExecution != null}">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="test-stats">
                <h4 style="margin-top: 0; color: #0369a1;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" th:text="${testExecution.stepExecutions.size()}">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ —à–∞–≥–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" style="color: #059669;"
                             th:text="${testExecution.stepExecutions.?[success == true].size()}">0</div>
                        <div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" style="color: #dc2626;"
                             th:text="${testExecution.stepExecutions.size() - testExecution.stepExecutions.?[success == true].size()}">0</div>
                        <div class="stat-label">–û—à–∏–±–æ—á–Ω—ã—Ö</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number"
                             th:classappend="${testExecution.status == 'SUCCESS'} ? 'text-green-600' :
                                            ${testExecution.status == 'FAILED'} ? 'text-orange-600' : 'text-red-600'"
                             th:text="${testExecution.status}">UNKNOWN</div>
                        <div class="stat-label">–°—Ç–∞—Ç—É—Å</div>
                    </div>
                </div>
            </div>

            <!-- –î–µ—Ç–∞–ª–∏ –ø–æ —à–∞–≥–∞–º -->
            <h4 style="color: #4b5563; margin-bottom: 15px;">–î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —à–∞–≥–æ–≤</h4>
            <div th:each="step, iterStat : ${testExecution.stepExecutions}">
                <div class="step-item" th:classappend="${step.success} ? 'step-success' : 'step-failed'">

                    <div class="step-header">
                        <div class="step-icon" th:classappend="${step.success} ? 'icon-success' : 'icon-failed'">
                            <span th:text="${step.success} ? '‚úì' : '‚úó'"></span>
                        </div>
                        <strong th:text="'–®–∞–≥ ' + ${iterStat.index + 1} + ': ' + ${step.stepName}"></strong>
                    </div>

                    <div class="step-details">
                        <div><strong>URL:</strong> <span th:text="${step.method} + ' ' + ${step.endpoint}"></span></div>
                        <div><strong>–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞:</strong>
                            <span th:text="${step.responseStatus}"
                                  th:classappend="${step.responseStatus == 200} ? 'text-green-600' :
                                                 ${step.responseStatus >= 400} ? 'text-red-600' : 'text-orange-600'"></span>
                        </div>
                        <div th:if="${step.errorMessage}">
                            <strong>–û—à–∏–±–∫–∞:</strong> <span style="color: #dc2626;" th:text="${step.errorMessage}"></span>
                        </div>
                        <div th:if="${step.requestData}">
                            <strong>–î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:</strong>
                            <pre class="code-block" th:text="${step.requestData.length() > 100 ? step.requestData.substring(0, 100) + '...' : step.requestData}"></pre>
                        </div>
                        <div th:if="${step.responseData}">
                            <strong>–û—Ç–≤–µ—Ç:</strong>
                            <pre class="code-block" th:text="${step.responseData.length() > 150 ? step.responseData.substring(0, 150) + '...' : step.responseData}"></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ -->
            <div style="text-align: center; margin-top: 20px;">
                <a href="/reports" class="nav-link" style="background: #3b82f6; color: white; border: none;">
                    üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
                </a>
            </div>
        </div>
    </div>

    <div class="nav-links">
        <a href="/" class="nav-link">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
</div>
</body>
</html>